<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P&L Manager - Sistema de Gesti√≥n</title>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: data: blob:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://www.gstatic.com https://apis.google.com https://www.googletagmanager.com blob:; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: blob: https:; connect-src 'self' https:; worker-src 'self' blob:;">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>üìä P&L Manager</h2>
                <button id="mobileMenuBtn" class="mobile-menu-btn">‚ò∞</button>
            </div>
            
            <nav class="nav-menu">
                <button class="nav-item active" data-view="ocr">üìÑ Esc√°ner y Documentos</button>
                <button class="nav-item" data-view="cierres">üßæ Cierres</button>
                <button class="nav-item" data-view="proveedores">üè¢ Proveedores</button>
                <button class="nav-item" data-view="productos">ü•ò Productos</button>
                <button class="nav-item" data-view="escandallos">üìã Escandallos</button>
                <button class="nav-item" data-view="inventario">üì¶ Control de Stock</button>
                <button class="nav-item" data-view="pnl">üí∞ P&L</button>
                <div style="flex-grow: 1;"></div>
                <button class="nav-item" onclick="window.logout()" style="margin-top: 20px; color: #ff6b6b; display: flex; align-items: center; gap: 10px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                    Cerrar Sesi√≥n
                </button>
            </nav>
        </aside>

        <main class="main-content">
            <div class="header">
                <h1 id="viewTitle">P&L Manager</h1>
                <div id="headerActions" class="header-actions"></div>
            </div>

            <div id="ocrView" class="view">
                <div style="margin-bottom: 30px;">
                    <h2 style="color: #1f2d3d; font-size: 24px; font-weight: 700; margin-bottom: 8px;">üìÑ Esc√°ner y Documentos</h2>
                    <p style="color: #64748b; font-size: 14px; margin: 0;">Gestiona y digitaliza tus documentos.</p>
                </div>

                <div id="scanOptionsCard" class="form-card hidden" style="border: none; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 20px;">
                    <h3 style="font-size: 16px; color: #475569; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700;">Selecciona tipo de documento</h3>
                    <div class="ocr-tipo-selector">
                        <button type="button" class="ocr-tipo-btn" data-tipo="factura">
                            <span class="ocr-tipo-icon">üßæ</span>
                            <span class="ocr-tipo-label">Factura</span>
                        </button>
                        <button type="button" class="ocr-tipo-btn" data-tipo="ticket">
                            <span class="ocr-tipo-icon">üõí</span>
                            <span class="ocr-tipo-label">Ticket</span>
                        </button>
                        <button type="button" class="ocr-tipo-btn" data-tipo="albaran">
                            <span class="ocr-tipo-icon">üì¶</span>
                            <span class="ocr-tipo-label">Albar√°n</span>
                        </button>
                        <button type="button" class="ocr-tipo-btn" data-tipo="cierre">
                            <span class="ocr-tipo-icon">üí∞</span>
                            <span class="ocr-tipo-label">Cierre</span>
                        </button>
                    </div>
                    <div style="margin-top: 15px; text-align: right;">
                        <button type="button" id="btnCancelScan" class="btn-secondary">Cancelar</button>
                    </div>
                </div>

                <div id="ocrUploadCard" class="form-card hidden" style="border: none; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                    <h3 style="font-size: 16px; color: #475569; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700;">2Ô∏è‚É£ Sube tu archivo</h3>
                    
                    <div class="file-upload-zone" onclick="document.getElementById('ocrFile').click()">
                        <span class="upload-icon">‚òÅÔ∏è</span>
                        <p style="font-size: 16px; font-weight: 600; color: #334155; margin-bottom: 5px;">Arrastra tu documento aqu√≠ o haz clic</p>
                        <p style="font-size: 13px; color: #94a3b8;">Soporta: PDF, JPG, PNG, TIFF (Max 10MB)</p>
                        <input type="file" id="ocrFile" class="hidden" accept="image/jpeg,image/jpg,image/png,image/webp,image/bmp,image/tiff,application/pdf" capture="environment">
                    </div>

                    <!-- Bot√≥n Cancelar (Visible solo cuando NO hay archivo seleccionado) -->
                    <div id="ocrUploadCancelContainer" style="margin-top: 15px; text-align: center;">
                        <button type="button" id="ocrCancelUploadBtn" class="btn-secondary" style="width: 100%;">Cancelar</button>
                    </div>

                    <div id="fileSelectedInfo" class="hidden" style="margin-top: 20px; background: #f1f5f9; padding: 15px; border-radius: 8px; display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 24px;">üìÑ</span>
                            <div>
                                <p id="fileNameDisplay" style="font-weight: 600; margin: 0; color: #334155;">archivo.pdf</p>
                                <p style="font-size: 12px; margin: 0; color: #64748b;">Listo para analizar</p>
                            </div>
                        </div>
                        <button type="button" id="btnRemoveFile" style="background: none; border: none; color: #ef4444; font-weight: 600; cursor: pointer;">‚úï Quitar</button>
                    </div>

                    <div id="ocrPreviewContainer" class="ocr-preview-container hidden" style="margin-top: 25px;">
                        <div class="ocr-preview-image" style="border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);">
                            <img id="ocrPreviewImg" src="" alt="Vista previa">
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <!-- Bot√≥n Cancelar eliminado para evitar duplicidad con el bot√≥n 'X Quitar' superior -->
                            <button type="button" id="ocrAnalyzeBtn" class="btn-primary btn-large" style="flex: 2; display: flex; justify-content: center; align-items: center; gap: 10px;">
                                ‚ú® Extraer Datos Autom√°ticamente
                            </button>
                        </div>
                    </div>
                    <div id="ocrProgressBar" class="ocr-progress hidden">
                        <div class="progress-bar">
                            <div id="ocrProgressFill" class="progress-fill"></div>
                        </div>
                        <p id="ocrProgressText" style="color: #64748b; font-size: 13px; margin-top: 5px;">Procesando...</p>
                    </div>
                </div>

                <div id="ocrDataCard" class="form-card hidden">
                    <h3 style="font-size: 16px; color: #475569; margin-bottom: 15px;">3Ô∏è‚É£ Revisa los datos</h3>
                    <div id="ocrDynamicForm"></div>
                    <div class="form-actions" style="margin-top: 20px; display: flex; gap: 10px;">
                        <button type="button" id="ocrCancelBtn" class="btn-secondary" style="flex: 1;">Cancelar</button>
                        <button type="button" id="ocrSaveBtn" class="btn-primary" style="flex: 2;" disabled>‚úì Guardar en Sistema</button>
                    </div>
                </div>

                <div class="table-controls" style="display: flex; gap: 20px; align-items: center; margin-bottom: 15px; margin-top: 30px; border-top: 1px solid #e2e8f0; padding-top: 20px;">
                    <input type="hidden" id="documentFilter" value="all">
                    <div id="documentFilterWrapper" class="custom-select-wrapper" style="flex: 1;">
                        <div class="custom-select-trigger" onclick="window.app.toggleDocumentFilter(event)">
                            <span id="documentFilterText">Todos los documentos</span>
                            <span class="arrow">‚ñº</span>
                        </div>
                        <div id="documentFilterOptions" class="custom-select-options hidden">
                            <div class="custom-option" onclick="window.app.setDocumentFilter('all', 'Todos los documentos')">Todos los documentos</div>
                            <div class="custom-option" onclick="window.app.setDocumentFilter('recent', '√öltimos escaneados')">√öltimos escaneados</div>
                            <div class="custom-option" onclick="window.app.setDocumentFilter('factura', 'Facturas')">Facturas</div>
                            <div class="custom-option" onclick="window.app.setDocumentFilter('ticket', 'Tickets')">Tickets</div>
                            <div class="custom-option" onclick="window.app.setDocumentFilter('albaran', 'Albaranes')">Albaranes</div>
                            <div class="custom-option" onclick="window.app.setDocumentFilter('cierre', 'Cierres')">Cierres</div>
                        </div>
                    </div>
                    <button id="btnShowScanOptions" class="btn-primary" style="display: flex; align-items: center; gap: 8px; white-space: nowrap;">
                        <span>üì∑</span> Escanear Documento
                    </button>
                </div>

                <div id="listaFacturas"></div>
                <!-- listaAlbaranes removed as we are unifying lists -->
            </div>

            <div id="cierresView" class="view hidden">
                <div id="cierreFormCard" class="form-card hidden" style="background: #fff; border-left: 4px solid #1171ef;">
                    <h3>üßæ Nuevo Cierre de Caja</h3>
                    
                    <!-- PASO 1: FECHA Y TURNO -->
                    <div id="cierreStep1">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Fecha</label>
                                <input type="date" id="cierreFecha" required>
                            </div>
                            <div class="form-group">
                                <label>Turno</label>
                                <select id="cierreTurno">
                                    <option value="dia_completo" selected>D√≠a Completo</option>
                                    <option value="comida">Comida</option>
                                    <option value="cena">Cena</option>
                                </select>
                            </div>
                        </div>
                        <div style="text-align: right; margin-top: 20px;">
                            <button type="button" class="btn-secondary" onclick="window.app.collapseForm('cierre')">Cancelar</button>
                            <button type="button" class="btn-primary" onclick="window.app.iniciarCierre()">Comenzar Cierre</button>
                        </div>
                    </div>

                    <!-- PASO 2: FORMULARIO COMPLETO (Oculto inicialmente) -->
                    <form id="cierreForm" class="hidden">
                        <div class="cierre-section">
                            <h4 style="margin-bottom:15px; color:#2c3e50;">üí∂ Arqueo de Caja (Conteo Real)</h4>
                            <div style="display: flex; gap: 20px;">
                                <div style="flex: 1; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                    <h5 style="margin:0 0 10px 0; font-size:13px; color:#7f8c8d;">BILLETES</h5>
                                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                                        <div class="input-money-wrapper"><span class="currency-symbol">500‚Ç¨</span><input type="number" id="b500" class="billete-input" placeholder="0"></div>
                                        <div class="input-money-wrapper"><span class="currency-symbol">200‚Ç¨</span><input type="number" id="b200" class="billete-input" placeholder="0"></div>
                                        <div class="input-money-wrapper"><span class="currency-symbol">100‚Ç¨</span><input type="number" id="b100" class="billete-input" placeholder="0"></div>
                                        <div class="input-money-wrapper"><span class="currency-symbol">50‚Ç¨</span><input type="number" id="b50" class="billete-input" placeholder="0"></div>
                                        <div class="input-money-wrapper"><span class="currency-symbol">20‚Ç¨</span><input type="number" id="b20" class="billete-input" placeholder="0"></div>
                                        <div class="input-money-wrapper"><span class="currency-symbol">10‚Ç¨</span><input type="number" id="b10" class="billete-input" placeholder="0"></div>
                                        <div class="input-money-wrapper"><span class="currency-symbol">5‚Ç¨</span><input type="number" id="b5" class="billete-input" placeholder="0"></div>
                                    </div>
                                </div>
                                <div style="flex: 1; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                    <h5 style="margin:0 0 10px 0; font-size:13px; color:#7f8c8d;">MONEDAS</h5>
                                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                                        <div class="input-money-wrapper"><span class="currency-symbol">2‚Ç¨</span><input type="number" id="m2" class="billete-input" placeholder="0"></div>
                                        <div class="input-money-wrapper"><span class="currency-symbol">1‚Ç¨</span><input type="number" id="m1" class="billete-input" placeholder="0"></div>
                                        <div class="input-money-wrapper"><span class="currency-symbol">0.50</span><input type="number" id="m050" class="billete-input" placeholder="0"></div>
                                        <div class="input-money-wrapper"><span class="currency-symbol">0.20</span><input type="number" id="m020" class="billete-input" placeholder="0"></div>
                                        <div class="input-money-wrapper"><span class="currency-symbol">0.10</span><input type="number" id="m010" class="billete-input" placeholder="0"></div>
                                        <div class="input-money-wrapper"><span class="currency-symbol">0.05</span><input type="number" id="m005" class="billete-input" placeholder="0"></div>
                                        <div class="input-money-wrapper"><span class="currency-symbol">0.02</span><input type="number" id="m002" class="billete-input" placeholder="0"></div>
                                        <div class="input-money-wrapper"><span class="currency-symbol">0.01</span><input type="number" id="m001" class="billete-input" placeholder="0"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="total-efectivo-bar" style="margin-top: 15px; background: #2c3e50; color: white; padding: 10px 20px; border-radius: 6px; display: flex; justify-content: space-between; font-weight: 600;">
                                <span>TOTAL EFECTIVO REAL</span>
                                <span id="totalEfectivoDisplay">0.00 ‚Ç¨</span>
                            </div>
                        </div>

                        <div class="cierre-section">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                                <h4>üí≥ Dat√°fonos / TPVs (Real)</h4>
                                <button type="button" id="addDatafono" class="btn-secondary" style="padding: 5px 10px; font-size:12px;">+ A√±adir TPV</button>
                            </div>
                            <div id="datafonosContainer"></div>
                            <div class="total-efectivo-bar" style="margin-top: 15px; background: #2c3e50; color: white; padding: 10px 20px; border-radius: 6px; display: flex; justify-content: space-between; font-weight: 600;">
                                <span>TOTAL DAT√ÅFONOS</span>
                                <span id="totalDatafonosDisplay">0.00 ‚Ç¨</span>
                            </div>
                        </div>

                        <div class="cierre-section">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                                <h4>üì≤ Otros Medios de Pago (Real)</h4>
                                <button type="button" id="addOtroMedio" class="btn-secondary" style="padding: 5px 10px; font-size:12px;">+ A√±adir Medio</button>
                            </div>
                            <div id="otrosMediosContainer"></div>
                            <div class="total-efectivo-bar" style="margin-top: 15px; background: #2c3e50; color: white; padding: 10px 20px; border-radius: 6px; display: flex; justify-content: space-between; font-weight: 600;">
                                <span>TOTAL OTROS MEDIOS</span>
                                <span id="totalOtrosDisplay">0.00 ‚Ç¨</span>
                            </div>
                        </div>

                        <div class="cierre-section">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                                <h4>üõµ Delivery (Real - Plataformas)</h4>
                            </div>
                            <div class="form-group">
                                <label>Total Ingresado en Plataformas</label>
                                <input type="number" id="realDelivery" step="0.01" placeholder="0.00" oninput="window.app.calcularTotalesCierre()">
                            </div>
                        </div>

                        <div class="cierre-section" style="border-left-color: #34c759;">
                            <h4>üñ•Ô∏è Datos del POS (Ticket de Caja)</h4>
                            <p style="font-size:12px; color:#666; margin-bottom:10px;">Introduce lo que dice tu m√°quina registradora para calcular el cuadre.</p>
                            <div id="datosPOSContainer">
                                </div>
                            <div class="form-group">
                                <label>N¬∫ Tickets / Comensales</label>
                                <input type="number" id="posTickets" value="0">
                            </div>
                        </div>

                        <div class="resumen-tiempo-real">
                            <h4>‚úÖ BALANCE CIERRE DE CAJA</h4>
                            <table class="tabla-resumen-cierre">
                                <tbody id="resumenTbody"></tbody>
                            </table>
                        </div>

                        <div class="form-actions" style="margin-top: 20px; text-align: right;">
                            <button type="button" class="btn-secondary" onclick="window.app.collapseForm('cierre')">Cancelar</button>
                            <button type="submit" class="btn-primary">‚úì Guardar Cierre</button>
                        </div>
                    </form>
                </div>
                <div id="listaCierres"></div>
            </div>

            <div id="comprasView" class="view hidden"></div>

            <div id="proveedoresView" class="view hidden">
                <div id="proveedorFormCard" class="form-card hidden">
                    <h3>üè¢ Ficha de Proveedor</h3>
                    <form id="proveedorForm">
                        <div class="form-row">
                            <div class="form-group"><label>Nombre Comercial *</label><input type="text" id="proveedorNombreComercial" required></div>
                            <div class="form-group"><label>Raz√≥n Social</label><input type="text" id="proveedorRazonSocial"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>NIF/CIF *</label><input type="text" id="proveedorNifCif" required></div>
                            <div class="form-group"><label>Persona Contacto</label><input type="text" id="proveedorPersonaContacto"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>Tel√©fono</label><input type="text" id="proveedorTelefono"></div>
                            <div class="form-group"><label>Email</label><input type="email" id="proveedorEmail"></div>
                        </div>
                        <div class="form-group"><label>Web</label><input type="text" id="proveedorWeb"></div>
                        
                        <div class="form-row">
                            <div class="form-group"><label>Direcci√≥n Fiscal</label><input type="text" id="proveedorDireccionFiscal"></div>
                            <div class="form-group"><label>Direcci√≥n Env√≠o</label><input type="text" id="proveedorDireccionEnvioHabitual"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>C.P.</label><input type="text" id="proveedorCodigoPostal"></div>
                            <div class="form-group"><label>Ciudad</label><input type="text" id="proveedorCiudad"></div>
                            <div class="form-group"><label>Pa√≠s</label><input type="text" id="proveedorPais"></div>
                        </div>

                        <div class="form-row">
                            <div class="form-group"><label>M√©todo Pago Preferido</label><input type="text" id="proveedorMetodoPagoPreferido"></div>
                            <div class="form-group"><label>Plazo Pago (d√≠as)</label><input type="number" id="proveedorPlazoPagoDias"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>Descuento (%)</label><input type="number" id="proveedorDescuentoAcordadoPorcentaje" step="0.01"></div>
                            <div class="form-group"><label>IBAN</label><input type="text" id="proveedorIban"></div>
                        </div>
                        <div class="form-group"><label>Banco</label><input type="text" id="proveedorBanco"></div>
                        
                        <div class="form-row">
                            <div class="form-group"><label>Categor√≠a Principal</label><input type="text" id="proveedorCategoriaPrincipalCompra"></div>
                            <div class="form-group"><label>Subcategor√≠as</label><input type="text" id="proveedorSubcategoriasCompra"></div>
                        </div>

                        <div class="form-group"><label>Notas Condiciones</label><textarea id="proveedorNotasCondiciones"></textarea></div>
                        <div class="form-group"><label>Notas Internas</label><textarea id="proveedorNotasInternas"></textarea></div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Estado</label>
                                <select id="proveedorEstado">
                                    <option value="Activo">Activo</option>
                                    <option value="Inactivo">Inactivo</option>
                                </select>
                            </div>
                            <div class="form-group"><label>Fecha Alta</label><input type="date" id="proveedorFechaAlta" readonly style="background: #f0f0f0;"></div>
                        </div>
                        
                        <div class="form-actions" style="text-align: right;">
                            <button type="button" class="btn-secondary" onclick="window.app.toggleForm('proveedor')">Cancelar</button>
                            <button type="submit" class="btn-primary">‚úì Guardar Proveedor</button>
                        </div>
                    </form>
                </div>
                <div id="listaProveedores"></div>
            </div>

            <div id="productosView" class="view hidden">
                <div id="productoFormCard" class="form-card hidden">
                    <h3>ü•ò Ficha de Producto</h3>
                    <form id="productoForm">
                        <div class="form-row">
                            <div class="form-group"><label>Nombre *</label><input type="text" id="productoNombre" required></div>
                            <div class="form-group"><label>Proveedor</label><div id="productoProveedorDropdown"></div></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>Precio Neto Compra (‚Ç¨) *</label><input type="number" id="productoPrecio" step="0.001" required></div>
                            <div class="form-group"><label>Unidad Base *</label>
                                <select id="productoUnidadBase">
                                    <option value="kg">Kilogramo (kg)</option>
                                    <option value="L">Litro (L)</option>
                                    <option value="ud">Unidad (ud)</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div class="form-group">
                                <label>¬øEste producto viene empaquetado? (Ej: Caja de 6 botellas)</label>
                                <select id="productoEsEmpaquetado" onchange="window.app.toggleEmpaqueFields()">
                                    <option value="false">No, compro por unidades sueltas</option>
                                    <option value="true">S√≠, compro por cajas/packs</option>
                                </select>
                            </div>
                            <div id="empaqueFields" class="hidden">
                                <div class="form-row">
                                    <div class="form-group"><label>Tipo de Empaque</label><input type="text" id="productoTipoEmpaque" placeholder="Ej: Caja, Pack, Malla"></div>
                                    <div class="form-group"><label>Unidades por Empaque</label><input type="number" id="productoUnidadesPorEmpaque" step="0.01" placeholder="Ej: 6, 12, 24"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group"><label>Stock Actual (Estimado)</label><input type="number" id="productoStockActual" step="0.01"></div>
                        
                        <div class="form-actions" style="text-align: right;">
                            <button type="button" class="btn-secondary" onclick="window.app.toggleForm('producto')">Cancelar</button>
                            <button type="submit" class="btn-primary">‚úì Guardar Producto</button>
                        </div>
                    </form>
                </div>
                <div id="listaProductos"></div>
            </div>

            <div id="escandallosView" class="view hidden">
                <div id="escandalloFormCard" class="form-card hidden">
                    <h3>üìã Nuevo Escandallo</h3>
                    <form id="escandalloForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nombre del Plato *</label>
                                <input type="text" id="escandalloNombre" required placeholder="Ej: Hamburguesa Completa">
                            </div>
                            <div class="form-group">
                                <label>C√≥digo (Opcional)</label>
                                <input type="text" id="escandalloCodigo" placeholder="Ej: PL-001">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>PVP con IVA (‚Ç¨) *</label>
                                <input type="number" id="escandalloPVPConIVA" step="0.01" required oninput="window.app.calcularPVPNeto()">
                            </div>
                            <div class="form-group">
                                <label>Tipo IVA (%) *</label>
                                <select id="escandalloTipoIVA" required onchange="window.app.calcularPVPNeto()">
                                    <option value="10" selected>10% (Restauraci√≥n)</option>
                                    <option value="21">21% (Alcohol/Otros)</option>
                                    <option value="4">4% (Superreducido)</option>
                                    <option value="0">0% (Exento)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>PVP Neto (‚Ç¨)</label>
                                <input type="number" id="escandalloPVPNeto" step="0.01" readonly style="background-color: #f8f9fa;">
                            </div>
                        </div>

                        <div class="escandallo-ingredientes-section" style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h4 style="margin: 0;">üßÇ Ingredientes</h4>
                                <button type="button" class="btn-secondary" onclick="window.app.addIngredienteRow()">+ A√±adir Ingrediente</button>
                            </div>
                            <div id="ingredientesContainer">
                                <!-- Las filas se a√±aden din√°micamente -->
                            </div>
                        </div>

                        <div class="form-row" style="background: #e8f6f3; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <div class="form-group">
                                <label>Coste Total Neto (‚Ç¨)</label>
                                <input type="number" id="escandalloCosteTotalNeto" readonly style="font-weight: bold;">
                            </div>
                            <div class="form-group">
                                <label>Food Cost (%)</label>
                                <input type="number" id="escandalloFC" readonly style="font-weight: bold;">
                            </div>
                            <div class="form-group">
                                <label>Margen Bruto (%)</label>
                                <input type="number" id="escandalloMargen" readonly style="font-weight: bold;">
                            </div>
                        </div>

                        <div class="form-group"><label>Descripci√≥n / Notas</label><textarea id="escandalloNotas"></textarea></div>
                        
                        <div class="form-actions" style="text-align: right;">
                            <button type="button" class="btn-secondary" onclick="window.app.expandForm('escandallo')">Cancelar</button>
                            <button type="submit" class="btn-primary">‚úì Guardar Escandallo</button>
                        </div>
                    </form>
                </div>
                <div id="listaEscandallos"></div>
            </div>
            
            <div id="inventarioView" class="view hidden">
                <div id="inventarioFormCard" class="form-card hidden" style="border-left: 4px solid #e67e22;">
                    <h3>üì¶ Nuevo Inventario F√≠sico</h3>
                    
                    <!-- PASO 1: Configuraci√≥n Inicial -->
                    <div id="inventarioStep1">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Fecha del Conteo</label>
                                <input type="date" id="inventarioFecha" required>
                            </div>
                            <div class="form-group">
                                <label>Zona / Familia</label>
                                <select id="inventarioFamilia">
                                    <option value="Todo">Todo el local</option>
                                    <option value="Barra">Barra / Bebidas</option>
                                    <option value="Cocina">Cocina / Alimentos</option>
                                    <option value="Almacen">Almac√©n Seco</option>
                                </select>
                            </div>
                        </div>
                        <div style="text-align: right; margin-top: 20px;">
                            <button type="button" class="btn-secondary" onclick="window.app.collapseForm('inventario')">Cancelar</button>
                            <button type="button" class="btn-primary" onclick="window.app.iniciarInventario()">Comenzar Inventario</button>
                        </div>
                    </div>

                    <!-- PASO 2: Conteo (Oculto inicialmente) -->
                    <form id="inventarioForm" class="hidden">
                        <!-- Filtros -->
                        <div class="inventario-filters" style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; background: #f8f9fa; padding: 10px; border-radius: 8px;">
                            <div style="flex: 2; min-width: 200px;">
                                <input type="text" id="invSearch" placeholder="üîç Buscar producto..." oninput="window.app.filterInventarioTable()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div style="flex: 1; min-width: 150px;">
                                <select id="invFamiliaFilter" onchange="window.app.filterInventarioTable()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">Todas las Familias</option>
                                </select>
                            </div>
                            <div style="flex: 1; min-width: 150px;">
                                <select id="invSubfamiliaFilter" onchange="window.app.filterInventarioTable()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">Todas las Subfamilias</option>
                                </select>
                            </div>
                        </div>

                        <!-- Tabla de Productos -->
                        <div class="table-responsive" style="max-height: 500px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px;">
                            <table class="data-table" id="inventarioTable" style="width: 100%; border-collapse: collapse;">
                                <thead style="position: sticky; top: 0; background: white; z-index: 1;">
                                    <tr>
                                        <th style="padding: 10px; text-align: left; border-bottom: 2px solid #eee;">Producto</th>
                                        <th style="padding: 10px; text-align: right; border-bottom: 2px solid #eee;">Stock Te√≥rico</th>
                                        <th style="padding: 10px; text-align: right; border-bottom: 2px solid #eee;">Contado</th>
                                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #eee;">Estado</th>
                                    </tr>
                                </thead>
                                <tbody id="inventarioTableBody">
                                    <!-- Se llena din√°micamente -->
                                </tbody>
                            </table>
                        </div>

                        <div class="form-actions" style="margin-top: 30px; text-align: right; border-top: 1px solid #eee; padding-top: 20px;">
                            <button type="button" class="btn-secondary" onclick="window.app.collapseForm('inventario')">Cancelar</button>
                            <button type="submit" class="btn-primary">‚úì Finalizar y Guardar Stock</button>
                        </div>
                    </form>

                    <!-- Modal Contador (M√≥vil) -->
                    <div id="inventarioCounterModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; overflow-y: auto;">
                        <div style="padding: 20px; max-width: 600px; margin: 0 auto;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 15px;">
                                <h3 id="invCounterTitle" style="margin: 0; font-size: 1.4em;">Contar Producto</h3>
                                <button type="button" onclick="window.app.closeInventarioCounter()" style="background: none; border: none; font-size: 2em; cursor: pointer; color: #666;">√ó</button>
                            </div>
                            
                            <div style="margin-bottom: 30px; text-align: center; background: #f8f9fa; padding: 20px; border-radius: 12px;">
                                <p style="color: #666; margin: 0 0 10px 0; font-size: 1em;">Stock Actual (Te√≥rico)</p>
                                <div id="invCounterTeorico" style="font-size: 2em; font-weight: bold; color: #2c3e50;">0.00</div>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 30px;">
                                <label style="display: block; margin-bottom: 10px; font-weight: 600; font-size: 1.1em;">Cantidad Contada</label>
                                <input type="text" id="invCounterInput" class="form-control" style="width: 100%; font-size: 2.5em; text-align: center; padding: 15px; border: 2px solid #3498db; border-radius: 12px; background: #fff;" readonly>
                            </div>

                            <!-- Numpad -->
                            <div id="invNumpad" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px;">
                                <button type="button" onclick="window.app.numpadInput(7)" style="padding: 20px; font-size: 1.5em; border: 1px solid #e2e8f0; border-radius: 12px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">7</button>
                                <button type="button" onclick="window.app.numpadInput(8)" style="padding: 20px; font-size: 1.5em; border: 1px solid #e2e8f0; border-radius: 12px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">8</button>
                                <button type="button" onclick="window.app.numpadInput(9)" style="padding: 20px; font-size: 1.5em; border: 1px solid #e2e8f0; border-radius: 12px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">9</button>
                                <button type="button" onclick="window.app.numpadInput(4)" style="padding: 20px; font-size: 1.5em; border: 1px solid #e2e8f0; border-radius: 12px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">4</button>
                                <button type="button" onclick="window.app.numpadInput(5)" style="padding: 20px; font-size: 1.5em; border: 1px solid #e2e8f0; border-radius: 12px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">5</button>
                                <button type="button" onclick="window.app.numpadInput(6)" style="padding: 20px; font-size: 1.5em; border: 1px solid #e2e8f0; border-radius: 12px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">6</button>
                                <button type="button" onclick="window.app.numpadInput(1)" style="padding: 20px; font-size: 1.5em; border: 1px solid #e2e8f0; border-radius: 12px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">1</button>
                                <button type="button" onclick="window.app.numpadInput(2)" style="padding: 20px; font-size: 1.5em; border: 1px solid #e2e8f0; border-radius: 12px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">2</button>
                                <button type="button" onclick="window.app.numpadInput(3)" style="padding: 20px; font-size: 1.5em; border: 1px solid #e2e8f0; border-radius: 12px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">3</button>
                                <button type="button" onclick="window.app.numpadInput('.')" style="padding: 20px; font-size: 1.5em; border: 1px solid #e2e8f0; border-radius: 12px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">.</button>
                                <button type="button" onclick="window.app.numpadInput(0)" style="padding: 20px; font-size: 1.5em; border: 1px solid #e2e8f0; border-radius: 12px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">0</button>
                                <button type="button" onclick="window.app.numpadBackspace()" style="padding: 20px; font-size: 1.5em; border: 1px solid #e2e8f0; border-radius: 12px; background: #fff5f5; color: #e74c3c; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">‚å´</button>
                            </div>

                            <div style="display: flex; gap: 15px;">
                                <button type="button" class="btn-secondary" style="flex: 1; padding: 15px; font-size: 1.1em;" onclick="window.app.closeInventarioCounter()">Cancelar</button>
                                <button type="button" class="btn-primary" style="flex: 2; padding: 15px; font-size: 1.1em;" onclick="window.app.confirmInventarioCount(null, 'mobile')">Confirmar</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="listaInventarios"></div>
            </div>
            
            <div id="pnlView" class="view hidden"></div>

    <div id="confirmModal" class="modal">
        <div class="modal-content confirmation-card">
            <div class="modal-header-simple">
                <div class="icon-box" id="confirmIconBox">‚ö†Ô∏è</div>
                <h3 id="confirmTitle">T√≠tulo</h3>
            </div>
            <div class="modal-body-simple">
                <p id="confirmMessage">Mensaje</p>
            </div>
            <div class="modal-footer-simple" id="confirmFooter">
                <button id="cancelBtn" class="btn-secondary">Cancelar</button>
                <button id="confirmBtn" class="btn-danger">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="universalModal" class="modal">
        <div class="modal-content form-modal-card">
            <div class="modal-header-pro">
                <h3 id="universalModalTitle">‚úèÔ∏è Editar Registro</h3>
                <button class="close-modal-btn" onclick="document.getElementById('universalModal').classList.remove('show')">√ó</button>
            </div>
            <div id="universalModalBody" class="modal-body-pro">
                </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <div id="loginOverlay" class="login-overlay hidden">
        <div class="login-card">
            <div class="login-header">
                <h2>üîê P&L Manager</h2>
                <p>Acceso Seguro</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" placeholder="usuario@ejemplo.com" required>
                </div>
                <div class="form-group">
                    <label>Contrase√±a</label>
                    <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%; justify-content: center;">Entrar al Sistema</button>
            </form>
            <div id="loginError" class="login-error hidden"></div>
            <div class="login-footer">
                <small>Sistema v4.27.8 Cloud-Ready</small>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <script type="module" src="js/main.js"></script>
</body>
</html>