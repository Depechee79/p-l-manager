<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P&L Manager - Sistema de Gesti√≥n</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>üìä P&L Manager</h2>
                <div class="period-selector">
                    <select id="periodSelector">
                        <option value="dia">Hoy</option>
                        <option value="semana">Esta Semana</option>
                        <option value="mes" selected>Este Mes</option>
                        <option value="anio">Este A√±o</option>
                    </select>
                </div>
            </div>
            
            <nav class="nav-menu">
                <button class="nav-item active" data-view="ocr">üì∏ OCR</button>
                <button class="nav-item" data-view="cierres">üßæ Cierres</button>
                <button class="nav-item" data-view="compras">üì¶ Compras</button>
                <button class="nav-item" data-view="proveedores">üè¢ Proveedores</button>
                <button class="nav-item" data-view="productos">ü•ò Productos</button>
                <button class="nav-item" data-view="escandallos">üìã Escandallos</button>
                <button class="nav-item" data-view="inventario">üìä Inventario</button>
                <button class="nav-item" data-view="delivery">üõµ Delivery</button>
                <button class="nav-item" data-view="pnl">üí∞ P&L</button>
            </nav>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="main-content">
            <div class="header">
                <h1 id="viewTitle">OCR - Registro Manual</h1>
                <div class="header-stats">
                    <span id="totalPeriodo">0‚Ç¨</span>
                </div>
            </div>

            <!-- OCR VIEW -->
            <div id="ocrView" class="view">
                <div class="ocr-header-card">
                    <h2>üì∏ Sistema OCR Profesional</h2>
                    <p>Extracci√≥n autom√°tica de datos con Tesseract OCR - Conversi√≥n autom√°tica a precios NETOS sin IVA</p>
                </div>

                <!-- SELECTOR TIPO DOCUMENTO -->
                <div class="form-card">
                    <h3>1Ô∏è‚É£ Selecciona el Tipo de Documento</h3>
                    <div class="ocr-tipo-selector">
                        <button type="button" class="ocr-tipo-btn" data-tipo="factura">
                            <span class="ocr-tipo-icon">üßæ</span>
                            <span class="ocr-tipo-label">Factura Proveedor</span>
                        </button>
                        <button type="button" class="ocr-tipo-btn" data-tipo="albaran">
                            <span class="ocr-tipo-icon">üì¶</span>
                            <span class="ocr-tipo-label">Albar√°n</span>
                        </button>
                        <button type="button" class="ocr-tipo-btn" data-tipo="cierre">
                            <span class="ocr-tipo-icon">üí∞</span>
                            <span class="ocr-tipo-label">Cierre de Caja</span>
                        </button>
                        <button type="button" class="ocr-tipo-btn" data-tipo="delivery">
                            <span class="ocr-tipo-icon">üõµ</span>
                            <span class="ocr-tipo-label">Delivery</span>
                        </button>
                    </div>
                </div>

                <!-- CARGA Y AN√ÅLISIS -->
                <div id="ocrUploadCard" class="form-card hidden">
                    <h3>2Ô∏è‚É£ Cargar y Analizar Documento</h3>
                    <div class="form-group">
                        <label>üì§ Seleccionar Imagen o Hacer Foto</label>
                        <input type="file" id="ocrFile" accept="image/jpeg,image/jpg,image/png,image/webp,image/bmp,image/tiff,application/pdf" capture="environment" class="file-input">
                        <small class="form-help">Formatos: JPG, PNG, WEBP, BMP, TIFF ‚Ä¢ M√°ximo 10MB ‚Ä¢ Puedes hacer foto directa desde c√°mara ‚Ä¢ NO soporta PDF</small>
                    </div>
                    <div id="ocrPreviewContainer" class="ocr-preview-container hidden">
                        <div class="ocr-preview-image">
                            <img id="ocrPreviewImg" src="" alt="Vista previa">
                        </div>
                        <button type="button" id="ocrAnalyzeBtn" class="btn-primary btn-large">
                            üîç Analizar con OCR (Tesseract)
                        </button>
                    </div>
                    <div id="ocrProgressBar" class="ocr-progress hidden">
                        <div class="progress-bar">
                            <div id="ocrProgressFill" class="progress-fill"></div>
                        </div>
                        <p id="ocrProgressText">Analizando documento...</p>
                    </div>
                </div>

                <!-- FORMULARIO DIN√ÅMICO POR TIPO -->
                <div id="ocrDataCard" class="form-card hidden">
                    <h3>3Ô∏è‚É£ Verificar y Corregir Datos Extra√≠dos</h3>
                    <p class="ocr-confidence-legend">
                        <span class="confidence-high">üü¢ Alta confianza</span>
                        <span class="confidence-medium">üü° Revisar</span>
                        <span class="confidence-low">üî¥ Corregir obligatorio</span>
                    </p>
                    <div id="ocrDynamicForm"></div>
                    <div class="form-actions">
                        <button type="button" id="ocrSaveBtn" class="btn-primary btn-large" disabled>
                            ‚úì Guardar e Integrar Datos
                        </button>
                        <button type="button" id="ocrCancelBtn" class="btn-secondary">
                            ‚úó Cancelar
                        </button>
                    </div>
                </div>
            </div>

            <!-- CIERRES VIEW -->
            <div id="cierresView" class="view hidden">
                <button id="toggleCierreForm" class="btn-primary" style="margin-bottom: 20px;">+ Nuevo Cierre</button>
                
                <div id="cierreFormCard" class="form-card hidden">
                    <h3>üßæ Nuevo Cierre de Caja</h3>
                    <form id="cierreForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Fecha</label>
                                <input type="date" id="cierreFecha" required>
                            </div>
                            <div class="form-group">
                                <label>Turno</label>
                                <select id="cierreTurno" required>
                                    <option value="comida">Comida</option>
                                    <option value="cena">Cena</option>
                                    <option value="todo el d√≠a">Todo el d√≠a</option>
                                </select>
                            </div>
                        </div>

                        <!-- CONTEO EFECTIVO -->
                        <div class="cierre-section">
                            <h4>üíµ Conteo de Efectivo</h4>
                            <div class="billetes-grid-compact">
                                <div class="billete-item-compact"><label>500‚Ç¨</label><input type="number" id="b500" value="0" min="0" class="billete-input"><span class="billete-total">0‚Ç¨</span></div>
                                <div class="billete-item-compact"><label>200‚Ç¨</label><input type="number" id="b200" value="0" min="0" class="billete-input"><span class="billete-total">0‚Ç¨</span></div>
                                <div class="billete-item-compact"><label>100‚Ç¨</label><input type="number" id="b100" value="0" min="0" class="billete-input"><span class="billete-total">0‚Ç¨</span></div>
                                <div class="billete-item-compact"><label>50‚Ç¨</label><input type="number" id="b50" value="0" min="0" class="billete-input"><span class="billete-total">0‚Ç¨</span></div>
                                <div class="billete-item-compact"><label>20‚Ç¨</label><input type="number" id="b20" value="0" min="0" class="billete-input"><span class="billete-total">0‚Ç¨</span></div>
                                <div class="billete-item-compact"><label>10‚Ç¨</label><input type="number" id="b10" value="0" min="0" class="billete-input"><span class="billete-total">0‚Ç¨</span></div>
                                <div class="billete-item-compact"><label>5‚Ç¨</label><input type="number" id="b5" value="0" min="0" class="billete-input"><span class="billete-total">0‚Ç¨</span></div>
                                <div class="billete-item-compact"><label>2‚Ç¨</label><input type="number" id="m2" value="0" min="0" class="billete-input"><span class="billete-total">0‚Ç¨</span></div>
                                <div class="billete-item-compact"><label>1‚Ç¨</label><input type="number" id="m1" value="0" min="0" class="billete-input"><span class="billete-total">0‚Ç¨</span></div>
                                <div class="billete-item-compact"><label>0.50‚Ç¨</label><input type="number" id="m050" value="0" min="0" class="billete-input"><span class="billete-total">0‚Ç¨</span></div>
                                <div class="billete-item-compact"><label>0.20‚Ç¨</label><input type="number" id="m020" value="0" min="0" class="billete-input"><span class="billete-total">0‚Ç¨</span></div>
                                <div class="billete-item-compact"><label>0.10‚Ç¨</label><input type="number" id="m010" value="0" min="0" class="billete-input"><span class="billete-total">0‚Ç¨</span></div>
                                <div class="billete-item-compact"><label>0.05‚Ç¨</label><input type="number" id="m005" value="0" min="0" class="billete-input"><span class="billete-total">0‚Ç¨</span></div>
                                <div class="billete-item-compact"><label>0.02‚Ç¨</label><input type="number" id="m002" value="0" min="0" class="billete-input"><span class="billete-total">0‚Ç¨</span></div>
                                <div class="billete-item-compact"><label>0.01‚Ç¨</label><input type="number" id="m001" value="0" min="0" class="billete-input"><span class="billete-total">0‚Ç¨</span></div>
                            </div>
                            <div class="total-efectivo">
                                <strong>Total Efectivo Contado:</strong>
                                <span id="totalEfectivoContado">0.00‚Ç¨</span>
                            </div>
                        </div>

                        <!-- DAT√ÅFONOS -->
                        <div class="cierre-section">
                            <h4>üí≥ Dat√°fonos</h4>
                            <div id="datafonosContainer">
                                <div class="datafono-item">
                                    <input type="text" placeholder="Nombre TPV" class="datafono-nombre">
                                    <input type="number" step="0.01" value="0" min="0" placeholder="Importe" class="datafono-importe">
                                    <button type="button" class="btn-remove" onclick="this.parentElement.remove(); app.calcularTotalesCierre()">‚úó</button>
                                </div>
                            </div>
                            <button type="button" id="addDatafono" class="btn-secondary">+ A√±adir Dat√°fono</button>
                            <div class="total-efectivo">
                                <strong>Total Dat√°fonos:</strong>
                                <span id="totalDatafonos">0.00‚Ç¨</span>
                            </div>
                        </div>

                        <!-- OTROS MEDIOS -->
                        <div class="cierre-section">
                            <h4>üì± Otros Medios de Pago</h4>
                            <div id="otrosMediosContainer"></div>
                            <button type="button" id="addOtroMedio" class="btn-secondary">+ A√±adir Otro Medio</button>
                            <div class="total-efectivo" style="margin-top: 10px;">
                                <strong>Total Otros Medios:</strong>
                                <span id="totalOtrosMedios">0.00‚Ç¨</span>
                            </div>
                        </div>

                        <!-- DINERO B (SIN IVA) -->
                        <div class="cierre-section" style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 6px;">
                            <h4>üíµ Dinero B (Sin IVA)</h4>
                            <p style="font-size: 12px; color: #856404; margin-bottom: 10px;">‚ö†Ô∏è Este importe NO computa IVA en ning√∫n c√°lculo de la aplicaci√≥n</p>
                            <div class="form-group">
                                <label>Importe Dinero B</label>
                                <input type="number" step="0.01" id="dineroB" value="0" min="0">
                            </div>
                        </div>

                        <!-- DATOS POS -->
                        <div class="cierre-section">
                            <h4>üñ•Ô∏è Datos del POS (Sistema)</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Efectivo POS</label>
                                    <input type="number" step="0.01" id="posEfectivo" value="0" min="0">
                                </div>
                                <div class="form-group">
                                    <label>Tarjetas POS</label>
                                    <input type="number" step="0.01" id="posTarjetas" value="0" min="0">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Bizum POS</label>
                                    <input type="number" step="0.01" id="posBizum" value="0" min="0">
                                </div>
                                <div class="form-group">
                                    <label>Transferencias POS</label>
                                    <input type="number" step="0.01" id="posTransferencias" value="0" min="0">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>N¬∫ Tickets POS</label>
                                <input type="number" id="posTickets" value="0" min="0">
                            </div>
                        </div>

                        <!-- RESUMEN EN TIEMPO REAL -->
                        <div class="resumen-tiempo-real">
                            <h4>üìä Resumen de Cuadre (en tiempo real)</h4>
                            <table class="tabla-resumen-cierre">
                                <thead>
                                    <tr>
                                        <th>M√©todo</th>
                                        <th>POS declarado</th>
                                        <th>Real contado</th>
                                        <th>Diferencia</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>üí∂ Efectivo</td>
                                        <td><span id="resumenPOSEfectivo">0.00 ‚Ç¨</span></td>
                                        <td><span id="resumenRealEfectivo">0.00 ‚Ç¨</span></td>
                                        <td><span id="resumenDeltaEfectivo" class="delta-cero">0.00 ‚Ç¨</span></td>
                                    </tr>
                                    <tr>
                                        <td>üí≥ Tarjetas</td>
                                        <td><span id="resumenPOSTarjetas">0.00 ‚Ç¨</span></td>
                                        <td><span id="resumenRealTarjetas">0.00 ‚Ç¨</span></td>
                                        <td><span id="resumenDeltaTarjetas" class="delta-cero">0.00 ‚Ç¨</span></td>
                                    </tr>
                                    <tr>
                                        <td>üì≤ Bizum</td>
                                        <td><span id="resumenPOSBizum">0.00 ‚Ç¨</span></td>
                                        <td><span id="resumenRealBizum">0.00 ‚Ç¨</span></td>
                                        <td><span id="resumenDeltaBizum" class="delta-cero">0.00 ‚Ç¨</span></td>
                                    </tr>
                                    <tr>
                                        <td>üè¶ Transferencias</td>
                                        <td><span id="resumenPOSTrans">0.00 ‚Ç¨</span></td>
                                        <td><span id="resumenRealTrans">0.00 ‚Ç¨</span></td>
                                        <td><span id="resumenDeltaTrans" class="delta-cero">0.00 ‚Ç¨</span></td>
                                    </tr>
                                    <tr style="background: #fff9e6;">
                                        <td>üíµ Dinero B (sin IVA)</td>
                                        <td>‚Äì</td>
                                        <td><span id="resumenDineroB">0.00 ‚Ç¨</span></td>
                                        <td><span style="color: #856404;">No computa</span></td>
                                    </tr>
                                    <tr class="fila-total">
                                        <td><strong>TOTAL</strong></td>
                                        <td><strong><span id="resumenPOSTotal">0.00 ‚Ç¨</span></strong></td>
                                        <td><strong><span id="resumenRealTotal">0.00 ‚Ç¨</span></strong></td>
                                        <td><strong><span id="resumenDeltaTotal" class="delta-cero">0.00 ‚Ç¨</span></strong></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <button type="submit" class="btn-primary">‚úì Guardar Cierre</button>
                    </form>
                </div>
                <div class="list-section">
                    <h3>Cierres del Periodo</h3>
                    <div id="listaCierres"></div>
                </div>
            </div>

            <!-- COMPRAS VIEW -->
            <div id="comprasView" class="view hidden">
                <div class="form-card">
                    <h3>üîç Filtros de B√∫squeda</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Proveedor</label>
                            <input type="text" id="filtroProveedor" list="datalistProveedores" placeholder="Buscar por proveedor...">
                            <datalist id="datalistProveedores"></datalist>
                        </div>
                        <div class="form-group">
                            <label>Desde Fecha</label>
                            <input type="date" id="filtroFechaDesde">
                        </div>
                        <div class="form-group">
                            <label>Hasta Fecha</label>
                            <input type="date" id="filtroFechaHasta">
                        </div>
                    </div>
                    <button type="button" id="btnFiltrarCompras" class="btn-primary">üîç Filtrar</button>
                    <button type="button" id="btnLimpiarFiltros" class="btn-secondary">‚úó Limpiar</button>
                </div>

                <div class="tabs">
                    <button class="tab-btn active" data-tab="facturas">üìÑ Facturas</button>
                    <button class="tab-btn" data-tab="albaranes">üì¶ Albaranes</button>
                </div>

                <!-- FACTURAS TAB -->
                <div id="facturasTab" class="tab-content">
                    <div class="list-section">
                        <h3>Facturas</h3>
                        <div id="listaFacturas"></div>
                    </div>
                </div>

                <!-- ALBARANES TAB -->
                <div id="albaranesTab" class="tab-content hidden">
                    <div class="list-section">
                        <h3>Albaranes</h3>
                        <div id="listaAlbaranes"></div>
                    </div>
                </div>
            </div>

            <!-- PROVEEDORES VIEW -->
            <div id="proveedoresView" class="view hidden">
                <button id="toggleProveedorForm" class="btn-primary" style="margin-bottom: 20px;" onclick="app.toggleForm('proveedor')">+ Nuevo Proveedor</button>
                <div class="form-card hidden" id="proveedorFormCard">
                    <h3>Nuevo Proveedor</h3>
                    <form id="proveedorForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nombre Fiscal *</label>
                                <input type="text" id="proveedorNombreFiscal" required>
                            </div>
                            <div class="form-group">
                                <label>Nombre Comercial</label>
                                <input type="text" id="proveedorNombreComercial">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>NIF/CIF *</label>
                                <input type="text" id="proveedorNifCif" required>
                            </div>
                            <div class="form-group">
                                <label>Tipo *</label>
                                <select id="proveedorTipo" required>
                                    <option value="Comida">Comida</option>
                                    <option value="Bebida">Bebida</option>
                                    <option value="Mixto">Mixto</option>
                                    <option value="Otros">Otros</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Direcci√≥n</label>
                            <input type="text" id="proveedorDireccion">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>C√≥digo Postal</label>
                                <input type="text" id="proveedorCodigoPostal">
                            </div>
                            <div class="form-group">
                                <label>Ciudad</label>
                                <input type="text" id="proveedorCiudad">
                            </div>
                            <div class="form-group">
                                <label>Provincia</label>
                                <input type="text" id="proveedorProvincia">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Tel√©fono</label>
                                <input type="tel" id="proveedorTelefono">
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="proveedorEmail">
                            </div>
                            <div class="form-group">
                                <label>Persona Contacto</label>
                                <input type="text" id="proveedorContacto">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Forma de Pago</label>
                                <select id="proveedorFormaPago">
                                    <option value="Transferencia">Transferencia</option>
                                    <option value="Domiciliaci√≥n">Domiciliaci√≥n</option>
                                    <option value="Contado">Contado</option>
                                    <option value="Otros">Otros</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Condiciones Pago</label>
                                <input type="text" id="proveedorCondicionesPago" placeholder="ej: 30 d√≠as, 60 d√≠as">
                            </div>
                            <div class="form-group">
                                <label>Frecuencia Pedido</label>
                                <select id="proveedorFrecuencia">
                                    <option value="Diario">Diario</option>
                                    <option value="Semanal">Semanal</option>
                                    <option value="Quincenal">Quincenal</option>
                                    <option value="Mensual">Mensual</option>
                                    <option value="Bajo pedido">Bajo pedido</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Observaciones</label>
                            <textarea id="proveedorObservaciones" rows="2"></textarea>
                        </div>
                        <button type="submit" class="btn-primary">‚úì Guardar Proveedor</button>
                    </form>
                </div>
                <div class="list-section">
                    <h3>Lista de Proveedores</h3>
                    <div id="listaProveedores"></div>
                </div>
            </div>

            <!-- PRODUCTOS VIEW -->
            <div id="productosView" class="view hidden">
                <button id="toggleProductoForm" class="btn-primary" style="margin-bottom: 20px;" onclick="app.toggleForm('producto')">+ Nuevo Producto</button>
                <div class="form-card hidden" id="productoFormCard">
                    <h3>Nuevo Producto</h3>
                    <form id="productoForm">
                        <div class="form-group">
                            <label>Nombre *</label>
                            <input type="text" id="productoNombre" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Proveedor *</label>
                                <select id="productoProveedorId" required>
                                    <option value="">Seleccionar...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Precio Neto (‚Ç¨) *</label>
                                <input type="number" step="0.01" id="productoPrecio" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Unidad Base *</label>
                                <select id="productoUnidadBase" required>
                                    <option value="kg">kg (kilogramo)</option>
                                    <option value="g">g (gramo)</option>
                                    <option value="L">L (litro)</option>
                                    <option value="ml">ml (mililitro)</option>
                                    <option value="ud">ud (unidad)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Stock Actual</label>
                                <input type="number" step="0.001" id="productoStockActual" value="0">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>¬øViene empaquetado?</label>
                                <select id="productoEsEmpaquetado" onchange="app.toggleEmpaqueFields()">
                                    <option value="false">No</option>
                                    <option value="true">S√≠</option>
                                </select>
                            </div>
                        </div>
                        <div id="empaqueFields" class="hidden">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Tipo Empaque *</label>
                                    <select id="productoTipoEmpaque" onchange="app.updateResumenEmpaque()">
                                        <option value="Caja">Caja</option>
                                        <option value="Pack">Pack</option>
                                        <option value="Malla">Malla</option>
                                        <option value="Rack">Rack</option>
                                        <option value="Pal√©">Pal√©</option>
                                        <option value="Botella">Botella</option>
                                        <option value="Lata">Lata</option>
                                        <option value="Bandeja">Bandeja</option>
                                        <option value="Saco">Saco</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Unidades por Empaque *</label>
                                    <input type="number" step="0.001" id="productoUnidadesPorEmpaque" oninput="app.updateResumenEmpaque()" min="0.001">
                                    <small class="form-help">N√∫mero de <strong>unidades base</strong> que trae 1 empaque</small>
                                </div>
                            </div>
                            <div id="resumenEmpaque" style="background: #e8f5e9; border-left: 4px solid #4caf50; padding: 12px; margin-top: 10px; border-radius: 4px; display: none;">
                                <strong style="color: #2e7d32;">üì¶ Resumen empaque:</strong>
                                <div id="resumenEmpaqueTexto" style="font-size: 15px; margin-top: 5px; color: #1f2d3d;"></div>
                            </div>
                        </div>
                        <button type="submit" class="btn-primary">‚úì Guardar Producto</button>
                    </form>
                </div>
                <div class="list-section">
                    <h3>Cat√°logo de Productos</h3>
                    <div id="listaProductos"></div>
                </div>
            </div>

            <!-- ESCANDALLOS VIEW -->
            <div id="escandallosView" class="view hidden">
                <button id="toggleEscandalloForm" class="btn-primary" style="margin-bottom: 20px;">+ Nuevo Escandallo</button>
                
                <div id="escandalloFormCard" class="form-card hidden">
                    <h3>üìù Nuevo Escandallo</h3>
                    <form id="escandalloForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nombre del Plato</label>
                                <input type="text" id="escandalloNombre" required>
                            </div>
                            <div class="form-group">
                                <label>C√≥digo (opcional)</label>
                                <input type="text" id="escandalloCodigo">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>PVP con IVA (‚Ç¨) *</label>
                                <input type="number" step="0.01" id="escandalloPVPConIVA" required oninput="app.calcularPVPNeto()">
                            </div>
                            <div class="form-group">
                                <label>IVA Venta (fijo hosteler√≠a)</label>
                                <input type="text" id="escandalloTipoIVA" value="10" readonly style="background: #ecf0f1; cursor: not-allowed;">
                            </div>
                            <div class="form-group">
                                <label>PVP Neto (sin IVA) (‚Ç¨)</label>
                                <input type="number" step="0.01" id="escandalloPVPNeto" readonly style="background: #e8f5e9;">
                            </div>
                        </div>

                        <h4 style="margin-top: 20px;">üßÇ Ingredientes</h4>
                        <div id="ingredientesContainer"></div>
                        <button type="button" id="addIngrediente" class="btn-secondary" style="margin: 10px 0;">+ A√±adir Ingrediente</button>

                        <div class="form-row" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                            <div class="form-group">
                                <label>Coste Total Neto (‚Ç¨)</label>
                                <input type="number" step="0.01" id="escandalloCosteTotalNeto" readonly>
                            </div>
                            <div class="form-group">
                                <label>Food Cost %</label>
                                <input type="number" step="0.01" id="escandalloFC" readonly>
                            </div>
                            <div class="form-group">
                                <label>Margen Bruto %</label>
                                <input type="number" step="0.01" id="escandalloMargen" readonly>
                            </div>
                        </div>

                        <button type="submit" class="btn-primary" style="margin-top: 15px;">‚úì Guardar Escandallo</button>
                    </form>
                </div>
                
                <div class="list-section">
                    <h3>Lista de Escandallos</h3>
                    <div id="listaEscandallos"></div>
                </div>
            </div>

            <!-- INVENTARIO VIEW -->
            <div id="inventarioView" class="view hidden">
                <div class="form-card">
                    <h3>Nuevo Inventario</h3>
                    <form id="inventarioForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Fecha *</label>
                                <input type="date" id="inventarioFecha" required>
                            </div>
                            <div class="form-group">
                                <label>Familia</label>
                                <select id="inventarioFamilia" required>
                                    <option value="Todos">Todos los productos</option>
                                    <option value="Comida">Comida</option>
                                    <option value="Bebida">Bebida</option>
                                    <option value="Otros">Otros</option>
                                </select>
                            </div>
                        </div>
                        <h4 style="margin-top: 20px;">üì¶ Conteo por Producto</h4>
                        <p style="color: #7f8c8d; font-size: 13px; margin-bottom: 15px;">Completa el conteo de cada producto antes de a√±adir el siguiente.</p>
                        <div id="inventarioProductosContainer"></div>
                        <button type="button" id="addProductoInventario" class="btn-secondary" style="margin: 10px 0;">+ A√±adir Producto</button>
                        <button type="submit" class="btn-primary" style="margin-top: 15px;">‚úì Guardar Inventario</button>
                    </form>
                </div>
                <div class="list-section">
                    <h3>Historial de Inventarios</h3>
                    <div id="listaInventarios"></div>
                </div>
            </div>

            <!-- DELIVERY VIEW -->
            <div id="deliveryView" class="view hidden">
                <div class="form-card">
                    <h3>Nuevo Pedido Delivery</h3>
                    <form id="deliveryForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Fecha</label>
                                <input type="date" id="deliveryFecha" required>
                            </div>
                            <div class="form-group">
                                <label>Plataforma</label>
                                <select id="deliveryPlataforma" required>
                                    <option value="Just Eat">Just Eat</option>
                                    <option value="Uber Eats">Uber Eats</option>
                                    <option value="Glovo">Glovo</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Ventas Brutas (‚Ç¨)</label>
                                <input type="number" step="0.01" id="deliveryVentas" required>
                            </div>
                            <div class="form-group">
                                <label>Comisi√≥n (%)</label>
                                <input type="number" step="0.1" id="deliveryComision" required>
                            </div>
                        </div>
                        <button type="submit" class="btn-primary">‚úì Guardar Delivery</button>
                    </form>
                </div>
                <div class="list-section">
                    <h3>Pedidos del Periodo</h3>
                    <div id="listaDelivery"></div>
                </div>
            </div>

            <!-- P&L VIEW -->
            <div id="pnlView" class="view hidden">
                <div class="pnl-header">
                    <h2>üìä Cuenta de Explotaci√≥n Profesional</h2>
                    <p style="color: #7f8c8d; font-size: 14px;">Todos los valores SIN IVA ¬∑ Per√≠odo actual vs comparativa</p>
                </div>

                <!-- KPIs Principales -->
                <div class="pnl-kpis-grid">
                    <div class="pnl-kpi-card">
                        <div class="pnl-kpi-label">Ingresos Netos</div>
                        <div class="pnl-kpi-value" id="kpiIngresos">0‚Ç¨</div>
                        <div class="pnl-kpi-compare" id="kpiIngresosCompare"></div>
                    </div>
                    <div class="pnl-kpi-card">
                        <div class="pnl-kpi-label">Food Cost %</div>
                        <div class="pnl-kpi-value" id="kpiFoodCost">0%</div>
                        <div class="pnl-kpi-compare" id="kpiFoodCostCompare"></div>
                    </div>
                    <div class="pnl-kpi-card">
                        <div class="pnl-kpi-label">Margen Bruto %</div>
                        <div class="pnl-kpi-value" id="kpiMargen">0%</div>
                        <div class="pnl-kpi-compare" id="kpiMargenCompare"></div>
                    </div>
                    <div class="pnl-kpi-card">
                        <div class="pnl-kpi-label">EBITDA %</div>
                        <div class="pnl-kpi-value" id="kpiEBITDA">0%</div>
                        <div class="pnl-kpi-compare" id="kpiEBITDACompare"></div>
                    </div>
                </div>

                <!-- Cuenta Detallada -->
                <div class="pnl-cuenta-card">
                    <!-- 1. INGRESOS NETOS -->
                    <div class="pnl-section">
                        <h3 class="pnl-section-title">1. INGRESOS NETOS (SIN IVA)</h3>
                        <div class="pnl-line">
                            <span>Ventas Local (Cierres)</span>
                            <span id="plVentasLocal">0‚Ç¨</span>
                        </div>
                        <div class="pnl-line">
                            <span>Ventas Delivery</span>
                            <span id="plVentasDelivery">0‚Ç¨</span>
                        </div>
                        <div class="pnl-line pnl-total">
                            <span><strong>TOTAL INGRESOS NETOS</strong></span>
                            <span id="plTotalIngresos"><strong>0‚Ç¨</strong></span>
                        </div>
                    </div>

                    <!-- 2. COGS -->
                    <div class="pnl-section">
                        <h3 class="pnl-section-title">2. COSTES DIRECTOS (COGS)</h3>
                        <div class="pnl-line pnl-indent">
                            <span>Inventario Inicial</span>
                            <span id="plInvInicial">0‚Ç¨</span>
                        </div>
                        <div class="pnl-line pnl-indent">
                            <span>(+) Compras Netas (sin IVA)</span>
                            <span id="plComprasNetas">0‚Ç¨</span>
                        </div>
                        <div class="pnl-line pnl-indent">
                            <span>(‚àí) Inventario Final</span>
                            <span id="plInvFinal">0‚Ç¨</span>
                        </div>
                        <div class="pnl-line pnl-subtotal">
                            <span><strong>COGS Total</strong></span>
                            <span id="plCOGSTotal"><strong>0‚Ç¨</strong></span>
                        </div>
                        <div class="pnl-line pnl-indent">
                            <span class="pnl-ratio">‚îî‚îÄ COGS Comida</span>
                            <span id="plCOGSComida">0‚Ç¨</span>
                        </div>
                        <div class="pnl-line pnl-indent">
                            <span class="pnl-ratio">‚îî‚îÄ COGS Bebida</span>
                            <span id="plCOGSBebida">0‚Ç¨</span>
                        </div>
                        <div class="pnl-line pnl-ratio-line">
                            <span>Food Cost %</span>
                            <span id="plFoodCostPct" class="pnl-ratio-value">0%</span>
                        </div>
                    </div>

                    <!-- 3. MARGEN BRUTO -->
                    <div class="pnl-section">
                        <h3 class="pnl-section-title">3. MARGEN BRUTO</h3>
                        <div class="pnl-line pnl-total pnl-margen">
                            <span><strong>MARGEN BRUTO (Ingresos ‚àí COGS)</strong></span>
                            <span id="plMargenBruto"><strong>0‚Ç¨</strong></span>
                        </div>
                        <div class="pnl-line pnl-ratio-line">
                            <span>Margen Bruto %</span>
                            <span id="plMargenPct" class="pnl-ratio-value">0%</span>
                        </div>
                    </div>

                    <!-- 4. GASTOS DE PERSONAL -->
                    <div class="pnl-section">
                        <h3 class="pnl-section-title">4. GASTOS DE PERSONAL</h3>
                        <div class="pnl-line pnl-indent">
                            <span>Salarios Brutos</span>
                            <span id="plSalarios">0‚Ç¨</span>
                        </div>
                        <div class="pnl-line pnl-indent">
                            <span>Seguridad Social</span>
                            <span id="plSeguridadSocial">0‚Ç¨</span>
                        </div>
                        <div class="pnl-line pnl-subtotal">
                            <span><strong>TOTAL PERSONAL</strong></span>
                            <span id="plTotalPersonal"><strong>0‚Ç¨</strong></span>
                        </div>
                        <div class="pnl-line pnl-ratio-line">
                            <span>Personal % s/Ventas</span>
                            <span id="plPersonalPct" class="pnl-ratio-value">0%</span>
                        </div>
                    </div>

                    <!-- 5. GASTOS OPERATIVOS -->
                    <div class="pnl-section">
                        <h3 class="pnl-section-title">5. GASTOS OPERATIVOS (OPEX)</h3>
                        <div class="pnl-line pnl-indent">
                            <span>Alquiler / Hipoteca</span>
                            <span id="plAlquiler">0‚Ç¨</span>
                        </div>
                        <div class="pnl-line pnl-indent">
                            <span>Suministros (Luz, Agua, Gas)</span>
                            <span id="plSuministros">0‚Ç¨</span>
                        </div>
                        <div class="pnl-line pnl-indent">
                            <span>Servicios (Gestor√≠a, Asesor√≠a)</span>
                            <span id="plServicios">0‚Ç¨</span>
                        </div>
                        <div class="pnl-line pnl-indent">
                            <span>Marketing y Publicidad</span>
                            <span id="plMarketing">0‚Ç¨</span>
                        </div>
                        <div class="pnl-line pnl-indent">
                            <span>Comisiones TPV/Delivery</span>
                            <span id="plComisiones">0‚Ç¨</span>
                        </div>
                        <div class="pnl-line pnl-indent">
                            <span>Limpieza y Mantenimiento</span>
                            <span id="plLimpieza">0‚Ç¨</span>
                        </div>
                        <div class="pnl-line pnl-indent">
                            <span>Seguros</span>
                            <span id="plSeguros">0‚Ç¨</span>
                        </div>
                        <div class="pnl-line pnl-indent">
                            <span>Otros Gastos Operativos</span>
                            <span id="plOtrosOpex">0‚Ç¨</span>
                        </div>
                        <div class="pnl-line pnl-subtotal">
                            <span><strong>TOTAL OPEX</strong></span>
                            <span id="plTotalOpex"><strong>0‚Ç¨</strong></span>
                        </div>
                        <div class="pnl-line pnl-ratio-line">
                            <span>OPEX % s/Ventas</span>
                            <span id="plOpexPct" class="pnl-ratio-value">0%</span>
                        </div>
                    </div>

                    <!-- 6. EBITDA -->
                    <div class="pnl-section">
                        <h3 class="pnl-section-title">6. EBITDA (Resultado Operativo)</h3>
                        <div class="pnl-line pnl-total pnl-ebitda">
                            <span><strong>EBITDA (Margen Bruto ‚àí Personal ‚àí OPEX)</strong></span>
                            <span id="plEBITDA"><strong>0‚Ç¨</strong></span>
                        </div>
                        <div class="pnl-line pnl-ratio-line">
                            <span>EBITDA % s/Ventas</span>
                            <span id="plEBITDAPct" class="pnl-ratio-value">0%</span>
                        </div>
                    </div>

                    <!-- 7. FINANCIEROS Y AMORTIZACIONES -->
                    <div class="pnl-section">
                        <h3 class="pnl-section-title">7. FINANCIEROS Y AMORTIZACIONES</h3>
                        <div class="pnl-line pnl-indent">
                            <span>Gastos Financieros (intereses)</span>
                            <span id="plFinancieros">0‚Ç¨</span>
                        </div>
                        <div class="pnl-line pnl-indent">
                            <span>Amortizaciones</span>
                            <span id="plAmortizaciones">0‚Ç¨</span>
                        </div>
                    </div>

                    <!-- 8. BENEFICIO NETO -->
                    <div class="pnl-section">
                        <h3 class="pnl-section-title">8. BENEFICIO NETO</h3>
                        <div class="pnl-line pnl-total pnl-beneficio">
                            <span><strong>BENEFICIO NETO (BAI)</strong></span>
                            <span id="plBeneficioNeto"><strong>0‚Ç¨</strong></span>
                        </div>
                        <div class="pnl-line pnl-ratio-line">
                            <span>Margen Neto %</span>
                            <span id="plMargenNetoPct" class="pnl-ratio-value">0%</span>
                        </div>
                    </div>
                </div>

                <!-- Alertas -->
                <div id="pnlAlertas" class="pnl-alertas"></div>
            </div>
        </main>
    </div>

    <div id="toast" class="toast"></div>

    <!-- Modal Informativo -->
    <div id="appModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="modalIcon" class="modal-icon"></span>
                <h3 id="modalTitle"></h3>
            </div>
            <div class="modal-body">
                <p id="modalMessage"></p>
            </div>
            <div class="modal-footer">
                <button class="btn-primary" onclick="document.getElementById('appModal').classList.remove('show')">Aceptar</button>
            </div>
        </div>
    </div>

    <!-- Modal Confirmaci√≥n -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-icon">‚ö†Ô∏è</span>
                <h3 id="confirmTitle"></h3>
            </div>
            <div class="modal-body">
                <p id="confirmMessage"></p>
            </div>
            <div class="modal-footer">
                <button id="cancelBtn" class="btn-secondary">Cancelar</button>
                <button id="confirmBtn" class="btn-danger">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal Alta R√°pida de Producto desde Inventario -->
    <div id="modalAltaRapidaProducto" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 500px;">
            <h3>‚ûï Alta R√°pida de Producto</h3>
            <form id="altaRapidaProductoForm">
                <div class="form-group">
                    <label>Nombre del Producto *</label>
                    <input type="text" id="altaRapidaNombre" required>
                </div>
                <div class="form-group">
                    <label>Unidad Base *</label>
                    <select id="altaRapidaUnidadBase" required>
                        <option value="">Seleccionar...</option>
                        <option value="kg">kg (kilogramo)</option>
                        <option value="g">g (gramo)</option>
                        <option value="L">L (litro)</option>
                        <option value="ml">ml (mililitro)</option>
                        <option value="ud">ud (unidad)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>¬øViene empaquetado?</label>
                    <select id="altaRapidaEsEmpaquetado" onchange="app.toggleAltaRapidaEmpaque()">
                        <option value="false">No</option>
                        <option value="true">S√≠ (cajas, packs, mallas, etc.)</option>
                    </select>
                </div>
                <div id="altaRapidaEmpaqueFields" class="hidden">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tipo de Empaque *</label>
                            <select id="altaRapidaTipoEmpaque">
                                <option value="Caja">Caja</option>
                                <option value="Pack">Pack</option>
                                <option value="Malla">Malla</option>
                                <option value="Bolsa">Bolsa</option>
                                <option value="Bandeja">Bandeja</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Unidades por Empaque *</label>
                            <input type="number" step="0.001" id="altaRapidaUnidadesPorEmpaque" min="0.001">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Precio Neto (‚Ç¨, opcional)</label>
                    <input type="number" step="0.01" id="altaRapidaPrecioNeto" min="0">
                    <small style="color: #7f8c8d;">Puedes dejarlo vac√≠o y completarlo m√°s tarde.</small>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn-secondary" onclick="app.cerrarModalAltaRapida()">Cancelar</button>
                    <button type="submit" class="btn-primary">‚úì Crear Producto</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Configurar PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <script src="app.js"></script>
</body>
</html>
